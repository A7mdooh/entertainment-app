<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مونوبولي سلطنة عُمان</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --oman-red: #db1f1f;
            --oman-green: #008000;
            --oman-white: #ffffff;
            --gold: #FFD700;
            --dark-blue: #003366;
            --light-green: #00a65a;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #e8f5e8 100%);
            margin: 0;
            padding: 0;
            color: #333;
            min-height: 100vh;
        }

        /* أزرار التحكم */
        .control-btn {
            position: fixed;
            top: 15px;
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px;
            z-index: 2147483647;
            border-radius: 50%;
            background-color: rgba(255,255,255,0.9);
            box-shadow: var(--shadow);
        }
        
        .control-btn:hover {
            transform: scale(1.1);
            background-color: var(--oman-red);
            color: white;
        }
        
        #homeBtn {
            right: 15px;
        }
        
        #fullscreenBtn {
            left: 15px;
        }

        header {
            background: linear-gradient(135deg, var(--oman-red) 0%, #a01717 100%);
            color: var(--oman-white);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow);
            position: relative;
        }

        header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .oman-btn {
            background: linear-gradient(135deg, var(--oman-green) 0%, var(--light-green) 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 8px;
            border-radius: 25px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .oman-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .oman-btn:hover::before {
            left: 100%;
        }

        .oman-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .oman-btn:active {
            transform: translateY(0);
        }

        .game-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 1400px;
            margin: 30px auto;
            gap: 30px;
            padding: 0 20px;
        }

        .game-board {
            width: 700px;
            height: 700px;
            background: linear-gradient(135deg, #f9f3e9 0%, #fff8e1 100%);
            position: relative;
            border: 15px solid var(--dark-blue);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: grid;
            grid-template-columns: repeat(11, 1fr);
            grid-template-rows: repeat(11, 1fr);
            animation: boardGlow 3s ease-in-out infinite alternate;
        }

        @keyframes boardGlow {
            0% { box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
            100% { box-shadow: 0 10px 40px rgba(219, 31, 31, 0.3); }
        }

        .board-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid #ddd;
            font-size: 11px;
            text-align: center;
            padding: 3px;
            position: relative;
            background-color: rgba(255,255,255,0.9);
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .corner-cell {
            background: linear-gradient(135deg, var(--oman-red) 0%, #a01717 100%);
            color: white;
            font-weight: bold;
            font-size: 12px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .property-cell {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .property-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .player-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, white 0%, #f8f9fa 100%);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            width: 280px;
            border: 3px solid var(--oman-green);
        }

        .player-controls h3 {
            color: var(--oman-red);
            margin-bottom: 20px;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .dice-container {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin: 25px 0;
            gap: 15px;
        }

        .dice {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, white 0%, #f0f0f0 100%);
            border: 3px solid var(--oman-red);
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            font-weight: bold;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            animation: diceFloat 2s ease-in-out infinite alternate;
        }

        @keyframes diceFloat {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-5px); }
        }

        .dice:hover {
            transform: scale(1.1) translateY(-5px);
        }

        .player-info {
            background: linear-gradient(135deg, white 0%, #f8f9fa 100%);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            width: 280px;
            border: 3px solid var(--gold);
        }

        .current-player {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 2px solid #eee;
            text-align: center;
        }

        .current-player h3 {
            color: var(--oman-red);
            font-size: 1.3rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .current-player p {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--oman-green);
        }

        #properties-list {
            list-style-type: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
        }

        #properties-list li {
            padding: 8px 12px;
            margin: 5px 0;
            background-color: rgba(0, 128, 0, 0.1);
            border-right: 4px solid var(--oman-green);
            border-radius: 5px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #properties-list li:hover {
            background-color: rgba(0, 128, 0, 0.2);
            transform: translateX(5px);
        }

        .player-token {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            position: absolute;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 5;
            border: 3px solid white;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            animation: tokenPulse 2s ease-in-out infinite alternate;
        }

        @keyframes tokenPulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }

        /* أنماط النوافذ المنبثقة المحدثة */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            overflow: auto;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #fefefe 0%, #f8f9fa 100%);
            margin: 3% auto;
            padding: 30px;
            border: 5px solid var(--oman-red);
            border-radius: 20px;
            width: 85%;
            max-width: 800px;
            position: relative;
            animation: modalSlideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        @keyframes modalSlideIn {
            from {opacity: 0; transform: translateY(-100px) scale(0.8);}
            to {opacity: 1; transform: translateY(0) scale(1);}
        }

        .close {
            color: var(--oman-red);
            float: left;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 5px;
            border-radius: 50%;
        }

        .close:hover {
            background-color: var(--oman-red);
            color: white;
            transform: scale(1.2);
        }

        .modal-header {
            padding: 15px 0;
            border-bottom: 3px solid var(--oman-green);
        }

        .modal-body {
            padding: 25px 0;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 15px 0;
            border-top: 3px solid var(--oman-green);
            text-align: center;
        }

        .modal h2 {
            color: var(--oman-red);
            text-align: center;
            font-size: 2.2rem;
            margin-bottom: 20px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .modal h3 {
            color: var(--oman-green);
            margin-top: 25px;
            font-weight: 600;
            font-size: 1.3rem;
        }

        .close-btn {
            background: linear-gradient(135deg, var(--oman-red) 0%, #a01717 100%);
        }

        .close-btn:hover {
            background: linear-gradient(135deg, #a01717 0%, #8b1414 100%);
        }

        /* تحسين ألوان العقارات */
        .property-brown {
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
            color: white;
            border: 2px solid #654321;
        }

        .property-lightblue {
            background: linear-gradient(135deg, #ADD8E6 0%, #87CEEB 100%);
            color: #003366;
            border: 2px solid #4682B4;
        }

        .property-pink {
            background: linear-gradient(135deg, #FFC0CB 0%, #FFB6C1 100%);
            color: #8B008B;
            border: 2px solid #DA70D6;
        }

        .property-orange {
            background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
            color: white;
            border: 2px solid #FF6347;
        }

        .property-red {
            background: linear-gradient(135deg, #FF0000 0%, #DC143C 100%);
            color: white;
            border: 2px solid #B22222;
        }

        .property-yellow {
            background: linear-gradient(135deg, #FFFF00 0%, #FFD700 100%);
            color: #8B4513;
            border: 2px solid #DAA520;
        }

        .property-green {
            background: linear-gradient(135deg, #008000 0%, #228B22 100%);
            color: white;
            border: 2px solid #006400;
        }

        .property-darkblue {
            background: linear-gradient(135deg, #00008B 0%, #191970 100%);
            color: white;
            border: 2px solid #000080;
        }

        .property-station {
            background: linear-gradient(135deg, #333333 0%, #555555 100%);
            color: white;
            border: 2px solid #000000;
        }

        .property-utility {
            background: linear-gradient(135deg, #FFFFFF 0%, #F0F0F0 100%);
            border: 3px dashed var(--oman-green);
            color: var(--oman-green);
        }

        /* تحسينات إضافية لواجهة اختيار الطلاب */
        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            padding: 15px;
        }

        .student-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid var(--oman-green);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .student-card:hover {
            background: linear-gradient(135deg, var(--oman-green) 0%, var(--light-green) 100%);
            color: white;
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }

        .student-card.selected {
            background: linear-gradient(135deg, var(--oman-red) 0%, #a01717 100%);
            color: white;
            border-color: var(--oman-red);
        }

        .selected-student-chip {
            display: inline-block;
            background: linear-gradient(135deg, var(--oman-green) 0%, var(--light-green) 100%);
            color: white;
            padding: 5px 15px;
            margin: 5px;
            border-radius: 20px;
            font-weight: 600;
            position: relative;
        }

        .selected-student-chip .remove-btn {
            background: var(--oman-red);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            margin-right: 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .player-setup-section {
            background: rgba(0, 128, 0, 0.05);
            border: 2px solid var(--oman-green);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }

        /* تحسينات إضافية للبحث والتصفية */
        .search-container {
            position: relative;
            display: inline-block;
        }

        .search-input {
            padding: 12px 15px;
            border: 2px solid var(--oman-green);
            border-radius: 25px;
            width: 300px;
            text-align: center;
            font-family: 'Cairo', sans-serif;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--oman-red);
            box-shadow: 0 0 10px rgba(219, 31, 31, 0.3);
            transform: scale(1.02);
        }

        .student-counter {
            text-align: center;
            padding: 12px;
            background: linear-gradient(135deg, var(--oman-green) 0%, var(--light-green) 100%);
            color: white;
            border-radius: 15px;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 16px;
            box-shadow: var(--shadow);
        }

        .selection-status {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: 15px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .selection-complete {
            background: linear-gradient(135deg, var(--oman-green) 0%, var(--light-green) 100%);
            color: white;
        }

        .selection-incomplete {
            background: linear-gradient(135deg, var(--gold) 0%, #FFB347 100%);
            color: var(--dark-blue);
        }

        /* تحسين بطاقات الطلاب */
        .student-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid var(--oman-green);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }

        .student-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.6s;
        }

        .student-card:hover::before {
            left: 100%;
        }

        .student-card:hover {
            background: linear-gradient(135deg, var(--oman-green) 0%, var(--light-green) 100%);
            color: white;
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .student-card.selected {
            background: linear-gradient(135deg, var(--oman-red) 0%, #a01717 100%);
            color: white;
            border-color: var(--oman-red);
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(219, 31, 31, 0.4);
        }

        .student-card.selected::after {
            content: '✓';
            position: absolute;
            top: 5px;
            left: 5px;
            background: white;
            color: var(--oman-red);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* تحسين محدد الصف */
        #class-selector {
            background: linear-gradient(135deg, white 0%, #f8f9fa 100%);
            border: 2px solid var(--oman-green);
            border-radius: 20px;
            padding: 10px 15px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            color: var(--dark-blue);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        #class-selector:focus {
            outline: none;
            border-color: var(--oman-red);
            box-shadow: 0 0 10px rgba(219, 31, 31, 0.3);
            transform: scale(1.02);
        }

        #class-selector option {
            padding: 10px;
            background: white;
            color: var(--dark-blue);
        }

        /* تحسين حالة الاختيار */
        .class-info {
            background: linear-gradient(135deg, var(--gold) 0%, #FFB347 100%);
            color: var(--dark-blue);
            padding: 8px 15px;
            border-radius: 15px;
            font-weight: bold;
            margin: 10px 0;
            text-align: center;
        }
        @media (max-width: 768px) {
            .game-container {
                flex-direction: column;
                align-items: center;
                padding: 10px;
            }
            
            .game-board {
                width: 90vw;
                height: 90vw;
                max-width: 500px;
                max-height: 500px;
            }
            
            .player-controls, .player-info {
                width: 90%;
                max-width: 400px;
            }
            
            .control-btn {
                font-size: 20px;
            }
            
            header h1 {
                font-size: 2rem;
            }
        }

        /* تأثيرات إضافية */
        .game-board:hover {
            transform: scale(1.02);
            transition: transform 0.3s ease;
        }

        .oman-btn.primary {
            background: linear-gradient(135deg, var(--oman-red) 0%, #a01717 100%);
        }

        .oman-btn.secondary {
            background: linear-gradient(135deg, var(--gold) 0%, #FFB347 100%);
            color: var(--dark-blue);
        }
    </style>
</head>
<body>
    <!-- أزرار التحكم -->
    <button class="control-btn" id="homeBtn" title="العودة للصفحة الرئيسية">🏠</button>
    <button class="control-btn" id="fullscreenBtn" title="ملء الشاشة/الخروج">⛶</button>

    <header>
        <h1>🏰 مونوبولي سلطنة عُمان 🎲</h1>
        <p>اكتشف معالم عُمان الجميلة واستثمر في أشهر المواقع السياحية</p>
        <button id="help-btn" class="oman-btn">📚 تعليمات اللعبة</button>
    </header>

    <main>
        <div class="game-container">
            <div class="game-board" id="game-board">
                <!-- سيتم توليد لوحة اللعب ديناميكيًا -->
            </div>

            <div class="player-controls">
                <h3>🎮 تحكم اللاعب</h3>
                <div class="dice-container">
                    <div class="dice" id="dice1">🎲</div>
                    <div class="dice" id="dice2">🎲</div>
                </div>
                <button id="roll-btn" class="oman-btn primary">🎯 اطر النرد</button>
                <button id="end-turn-btn" class="oman-btn secondary">⏭️ انهي دورك</button>
            </div>

            <div class="player-info">
                <div class="current-player">
                    <h3>👤 اللاعب الحالي: <span id="current-player-name">...</span></h3>
                    <p>💰 الرصيد: <span id="current-player-balance">0</span> ريال عُماني</p>
                </div>
                <div class="properties-owned">
                    <h4>🏘️ العقارات المملوكة:</h4>
                    <ul id="properties-list"></ul>
                </div>
            </div>
        </div>
    </main>

    <!-- نافذة التعليمات المنبثقة -->
    <div id="help-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>تعليمات لعبة مونوبولي عُمان</h2>
            <div class="modal-body">
                <h3>🎲 كيفية اللعب:</h3>
                <p>1. تبدأ اللعبة باختيار عدد اللاعبين وأسمائهم.</p>
                <p>2. يرمي اللاعب النرد ويتحرك حسب العدد الظاهر.</p>
                <p>3. عند الوقوف على عقار غير مملوك، يمكنك شراؤه أو بيعه في المزاد.</p>
                <p>4. إذا كان العقار مملوكًا لخصم، تدفع له إيجارًا حسب قيمة المربع.</p>
                
                <h3>🏰 المعالم العُمانية:</h3>
                <p>تحتوي اللعبة على أشهر المعالم في عُمان مثل:</p>
                <ul>
                    <li>قصر العلم</li>
                    <li>سوق مطرح</li>
                    <li>جبال الحجر</li>
                    <li>وادي شاب</li>
                    <li>قلعة نزوى</li>
                    <li>شاطئ المغسيل</li>
                </ul>
                
                <h3>💰 العملة:</h3>
                <p>تستخدم اللعبة الريال العُماني كعملة رئيسية.</p>
                
                <h3>🏆 الفوز:</h3>
                <p>يفوز آخر لاعب قادر على دفع ديونه وتبقى لديه أموال وعقارات.</p>
            </div>
            <div class="modal-footer">
                <button class="oman-btn close-btn">حسناً</button>
            </div>
        </div>
    </div>

    <!-- نافذة اختيار اللاعبين -->
    <div id="setup-modal" class="modal">
        <div class="modal-content">
            <h2>🎮 إعداد اللعبة</h2>
            <div class="modal-body">
                <div id="player-setup">
                    <h3>اختر عدد اللاعبين (2-6):</h3>
                    <select id="player-count" class="oman-btn" style="width: 200px; text-align: center;">
                        <option value="2">2 لاعبين</option>
                        <option value="3">3 لاعبين</option>
                        <option value="4">4 لاعبين</option>
                        <option value="5">5 لاعبين</option>
                        <option value="6">6 لاعبين</option>
                    </select>
                    
                    <div style="margin: 20px 0;">
                        <button id="use-student-data-btn" class="oman-btn secondary">📚 استخدام قائمة الصف</button>
                        <button id="manual-entry-btn" class="oman-btn">✏️ إدخال يدوي</button>
                    </div>
                    
                    <!-- قسم استخدام بيانات الطلاب -->
                    <div id="student-selection-section" style="display: none;">
                        <h4>🎯 اختيار الطلاب من القائمة:</h4>
                        
                        <!-- محدد الصف -->
                        <div style="margin: 15px 0; text-align: center;">
                            <label for="class-selector" style="display: block; margin-bottom: 10px; font-weight: bold; color: var(--oman-green);">📋 اختر الصف:</label>
                            <select id="class-selector" class="oman-btn" style="width: 250px; text-align: center;">
                                <option value="">جميع الصفوف</option>
                            </select>
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <button id="random-students-btn" class="oman-btn">🎲 اختيار عشوائي</button>
                            <button id="manual-students-btn" class="oman-btn secondary">👆 اختيار يدوي</button>
                        </div>
                        
                        <div id="student-grid" style="display: none; max-height: 400px; overflow-y: auto; border: 2px solid var(--oman-green); border-radius: 10px; padding: 10px; margin: 10px 0;">
                            <!-- سيتم ملؤها ديناميكياً -->
                        </div>
                        
                        <div id="selected-students-display" style="margin: 15px 0;">
                            <h5>الطلاب المختارون:</h5>
                            <div id="selected-students-list"></div>
                        </div>
                    </div>
                    
                    <!-- قسم الإدخال اليدوي -->
                    <div id="player-names-container">
                        <!-- سيتم إضافة حقول أسماء اللاعبين هنا -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="start-game-btn" class="oman-btn primary">🚀 ابدأ اللعبة</button>
            </div>
        </div>
    </div>

    <!-- نافذة شراء العقار -->
    <div id="buy-property-modal" class="modal">
        <div class="modal-content">
            <h2>شراء عقار</h2>
            <div class="modal-body">
                <p id="property-description"></p>
                <p id="property-price"></p>
            </div>
            <div class="modal-footer">
                <button id="buy-property-btn" class="oman-btn">شراء العقار</button>
                <button id="auction-property-btn" class="oman-btn">بيع بالمزاد</button>
            </div>
        </div>
    </div>

    <script>
        // إنشاء كائن الصوت
        const clickSound = new Audio('../assets/media/sounds/Click.mp3');
        clickSound.preload = 'auto';

        // وظيفة تشغيل الصوت
        function playClickSound() {
            clickSound.currentTime = 0;
            clickSound.play().catch(() => {});
        }

        // متغيرات اللعبة
        let currentPlayerIndex = 0;
        let players = [];
        let properties = [];
        let gameStarted = false;
        let currentProperty = null;

        // متغيرات اختيار الطلاب
        let selectedStudents = [];
        let useStudentData = false;

        // عناصر DOM الجديدة
        const useStudentDataBtn = document.getElementById('use-student-data-btn');
        const manualEntryBtn = document.getElementById('manual-entry-btn');
        const studentSelectionSection = document.getElementById('student-selection-section');
        const randomStudentsBtn = document.getElementById('random-students-btn');
        const manualStudentsBtn = document.getElementById('manual-students-btn');
        const studentGrid = document.getElementById('student-grid');
        const selectedStudentsList = document.getElementById('selected-students-list');
        const gameBoard = document.getElementById('game-board');
        const rollBtn = document.getElementById('roll-btn');
        const endTurnBtn = document.getElementById('end-turn-btn');
        const currentPlayerName = document.getElementById('current-player-name');
        const currentPlayerBalance = document.getElementById('current-player-balance');
        const propertiesList = document.getElementById('properties-list');
        const playerCountSelect = document.getElementById('player-count');
        const playerNamesContainer = document.getElementById('player-names-container');
        const startGameBtn = document.getElementById('start-game-btn');
        const helpBtn = document.getElementById('help-btn');
        const helpModal = document.getElementById('help-modal');
        const setupModal = document.getElementById('setup-modal');
        const buyPropertyModal = document.getElementById('buy-property-modal');
        const propertyDescription = document.getElementById('property-description');
        const propertyPrice = document.getElementById('property-price');
        const buyPropertyBtn = document.getElementById('buy-property-btn');
        const auctionPropertyBtn = document.getElementById('auction-property-btn');

        // ألوان اللاعبين (موسعة لـ 6 لاعبين)
        const playerColors = ['#FF0000', '#0000FF', '#00FF00', '#FFFF00', '#FF00FF', '#FFA500'];
        const playerTokens = ['🗡️', '⛵', '🐪', '🏰', '💎', '🌟'];

        // بيانات الطلاب والصفوف
        let studentData = [];
        let availableClasses = [];

        // تحميل بيانات الطلاب والصفوف
        async function loadStudentData() {
            try {
                // المحاولة الأولى: تحميل من الملف المحلي
                let response = await fetch('../data/studentData.json');
                
                if (!response.ok) {
                    // المحاولة الثانية: تحميل من GitHub
                    console.log('لم يتم العثور على الملف المحلي، جاري التحميل من GitHub...');
                    response = await fetch('https://raw.githubusercontent.com/A7mdooh/entertainment-app/main/data/studentData.json');
                }
                
                if (response.ok) {
                    const data = await response.json();
                    studentData = Array.isArray(data) ? data : [];
                    
                    if (studentData.length > 0) {
                        // استخراج الصفوف المتاحة
                        availableClasses = [...new Set(studentData.map(student => student.class).filter(cls => cls))];
                        availableClasses.sort();
                        
                        console.log(`تم تحميل ${studentData.length} طالب من ${availableClasses.length} صف`);
                        
                        // تحديث واجهة المستخدم
                        useStudentDataBtn.style.display = 'inline-block';
                        useStudentDataBtn.disabled = false;
                        useStudentDataBtn.innerHTML = '📚 استخدام قائمة الصف ✅';
                        
                        // إنشاء قائمة الصفوف
                        createClassSelector();
                    } else {
                        throw new Error('قائمة الطلاب فارغة');
                    }
                } else {
                    throw new Error(`فشل في تحميل البيانات: ${response.status}`);
                }
                
            } catch (error) {
                console.log('خطأ في تحميل بيانات الطلاب:', error.message);
                studentData = [];
                availableClasses = [];
                
                // تحديث واجهة المستخدم عند فشل التحميل
                useStudentDataBtn.style.display = 'inline-block';
                useStudentDataBtn.disabled = true;
                useStudentDataBtn.innerHTML = '📚 قائمة الصف غير متوفرة ❌';
                useStudentDataBtn.style.opacity = '0.6';
            }
        }

        // إنشاء محدد الصف
        function createClassSelector() {
            const classSelector = document.getElementById('class-selector');
            if (!classSelector) return;
            
            classSelector.innerHTML = '<option value="">اختر الصف...</option>';
            
            availableClasses.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classSelector.appendChild(option);
            });
        }

        // تصفية الطلاب حسب الصف المختار
        function filterStudentsByClass(selectedClass) {
            if (!selectedClass) {
                return studentData;
            }
            return studentData.filter(student => student.class === selectedClass);
        }

        // تهيئة اللعبة
        function initGame() {
            createProperties();
            renderBoard();
            updatePlayerInfo();
            setupModal.style.display = 'none';
            gameStarted = true;
        }

        // إنشاء العقارات العُمانية
        function createProperties() {
            properties = [
                { id: 0, name: 'البدء', type: 'corner', action: 'collect', amount: 200 },
                { id: 1, name: 'مطار مسقط الدولي', price: 200, rent: 25, color: 'brown', ownedBy: null, houses: 0 },
                { id: 2, name: 'سوق مطرح', price: 60, rent: 10, color: 'brown', ownedBy: null, houses: 0 },
                { id: 3, name: 'خزينة المجتمع', type: 'chest' },
                { id: 4, name: 'ضريبة الدخل', type: 'tax', amount: 200 },
                { id: 5, name: 'ميناء صحار', price: 200, rent: 25, type: 'station', ownedBy: null },
                { id: 6, name: 'وادي شاب', price: 100, rent: 30, color: 'lightblue', ownedBy: null, houses: 0 },
                { id: 7, name: 'فرصة', type: 'chance' },
                { id: 8, name: 'جبال الحجر', price: 100, rent: 30, color: 'lightblue', ownedBy: null, houses: 0 },
                { id: 9, name: 'وادي بني خالد', price: 120, rent: 40, color: 'lightblue', ownedBy: null, houses: 0 },
                { id: 10, name: 'السجن', type: 'jail' },
                { id: 11, name: 'قلعة نزوى', price: 140, rent: 50, color: 'pink', ownedBy: null, houses: 0 },
                { id: 12, name: 'شركة الكهرباء', price: 150, rent: 0, type: 'utility', ownedBy: null },
                { id: 13, name: 'قصر العلم', price: 140, rent: 50, color: 'pink', ownedBy: null, houses: 0 },
                { id: 14, name: 'متحف عُمان الوطني', price: 160, rent: 60, color: 'pink', ownedBy: null, houses: 0 },
                { id: 15, name: 'ميناء السلطان قابوس', price: 200, rent: 25, type: 'station', ownedBy: null },
                { id: 16, name: 'شاطئ المغسيل', price: 180, rent: 70, color: 'orange', ownedBy: null, houses: 0 },
                { id: 17, name: 'خزينة المجتمع', type: 'chest' },
                { id: 18, name: 'خور المغسيل', price: 180, rent: 70, color: 'orange', ownedBy: null, houses: 0 },
                { id: 19, name: 'وادي دوكة', price: 200, rent: 80, color: 'orange', ownedBy: null, houses: 0 },
                { id: 20, name: 'الراحة', type: 'free' },
                { id: 21, name: 'سوق نزوى', price: 220, rent: 90, color: 'red', ownedBy: null, houses: 0 },
                { id: 22, name: 'فرصة', type: 'chance' },
                { id: 23, name: 'وادي بني عوف', price: 220, rent: 90, color: 'red', ownedBy: null, houses: 0 },
                { id: 24, name: 'وادي تنوف', price: 240, rent: 100, color: 'red', ownedBy: null, houses: 0 },
                { id: 25, name: 'ميناء الدقم', price: 200, rent: 25, type: 'station', ownedBy: null },
                { id: 26, name: 'جبل شمس', price: 260, rent: 110, color: 'yellow', ownedBy: null, houses: 0 },
                { id: 27, name: 'جبل الأخضر', price: 260, rent: 110, color: 'yellow', ownedBy: null, houses: 0 },
                { id: 28, name: 'شركة المياه', price: 150, rent: 0, type: 'utility', ownedBy: null },
                { id: 29, name: 'وادي السحتن', price: 280, rent: 120, color: 'yellow', ownedBy: null, houses: 0 },
                { id: 30, name: 'اذهب إلى السجن', type: 'goToJail' },
                { id: 31, name: 'مدينة المعرفة', price: 300, rent: 130, color: 'green', ownedBy: null, houses: 0 },
                { id: 32, name: 'المنطقة الاقتصادية', price: 300, rent: 130, color: 'green', ownedBy: null, houses: 0 },
                { id: 33, name: 'خزينة المجتمع', type: 'chest' },
                { id: 34, name: 'جامعة السلطان قابوس', price: 320, rent: 150, color: 'green', ownedBy: null, houses: 0 },
                { id: 35, name: 'مطار صلالة', price: 200, rent: 25, type: 'station', ownedBy: null },
                { id: 36, name: 'فرصة', type: 'chance' },
                { id: 37, name: 'خور روري', price: 350, rent: 175, color: 'darkblue', ownedBy: null, houses: 0 },
                { id: 38, name: 'ضريبة الرفاهية', type: 'tax', amount: 100 },
                { id: 39, name: 'شاطئ البستان', price: 400, rent: 200, color: 'darkblue', ownedBy: null, houses: 0 }
            ];
        }

        // عرض لوحة اللعب
        function renderBoard() {
            gameBoard.innerHTML = '';
            
            // إنشاء لوحة 11x11 (مبسطة للعرض)
            for (let row = 0; row < 11; row++) {
                for (let col = 0; col < 11; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'board-cell';
                    
                    // تحديد الزوايا
                    if ((row === 0 && col === 0) || (row === 0 && col === 10) || 
                        (row === 10 && col === 0) || (row === 10 && col === 10)) {
                        cell.classList.add('corner-cell');
                        
                        if (row === 10 && col === 10) cell.textContent = 'البدء';
                        else if (row === 10 && col === 0) cell.textContent = 'السجن';
                        else if (row === 0 && col === 0) cell.textContent = 'الراحة';
                        else if (row === 0 && col === 10) cell.textContent = 'اذهب إلى السجن';
                    } 
                    // تحديد الجوانب
                    else if (row === 0 || row === 10 || col === 0 || col === 10) {
                        const property = findPropertyByPosition(row, col);
                        if (property) {
                            cell.textContent = property.name;
                            cell.classList.add('property-cell');
                            
                            if (property.color) cell.classList.add(`property-${property.color}`);
                            if (property.type === 'station') cell.classList.add('property-station');
                            if (property.type === 'utility') cell.classList.add('property-utility');
                        }
                    }
                    
                    gameBoard.appendChild(cell);
                }
            }
            
            // وضع قطع اللاعبين
            players.forEach(player => {
                const token = document.createElement('div');
                token.className = 'player-token';
                token.id = `token-${player.id}`;
                token.style.backgroundColor = player.color;
                gameBoard.appendChild(token);
                movePlayerToken(player.id, player.position || 0);
            });
        }

        // دالة مساعدة للعثور على العقار حسب الموضع
        function findPropertyByPosition(row, col) {
            // هذه دالة مبسطة، تحتاج لتحسين دقيق لمواقع المربعات
            if (row === 10 && col > 0 && col < 10) return properties[col];
            if (row === 0 && col > 0 && col < 10) return properties[20 + (10 - col)];
            if (col === 10 && row > 0 && row < 10) return properties[30 + (10 - row)];
            if (col === 0 && row > 0 && row < 10) return properties[10 + row];
            return null;
        }

        // دالة لتحريك قطعة اللاعب
        function movePlayerToken(playerId, position) {
            const token = document.getElementById(`token-${playerId}`);
            if (!token) return;
            
            // تحديد الموضع بناءً على رقم المربع (0-39)
            // هذه دالة مبسطة، تحتاج لتحسين دقيق لمواقع المربعات
            let row, col;
            
            if (position < 10) {
                row = 10;
                col = 10 - position;
            } else if (position < 20) {
                row = 20 - position;
                col = 0;
            } else if (position < 30) {
                row = 0;
                col = position - 20;
            } else {
                row = position - 30;
                col = 10;
            }
            
            token.style.gridRow = row + 1;
            token.style.gridColumn = col + 1;
        }

        // دالة لرمي النرد مع تأثيرات بصرية
        function rollDice() {
            if (!gameStarted) return;
            
            // تأثير رول النرد
            const dice1El = document.getElementById('dice1');
            const dice2El = document.getElementById('dice2');
            
            // أنيميشن النرد
            let rollCount = 0;
            const rollInterval = setInterval(() => {
                dice1El.textContent = Math.floor(Math.random() * 6) + 1;
                dice2El.textContent = Math.floor(Math.random() * 6) + 1;
                rollCount++;
                
                if (rollCount > 10) {
                    clearInterval(rollInterval);
                    
                    const dice1 = Math.floor(Math.random() * 6) + 1;
                    const dice2 = Math.floor(Math.random() * 6) + 1;
                    
                    dice1El.textContent = dice1;
                    dice2El.textContent = dice2;
                    
                    const total = dice1 + dice2;
                    
                    // إضافة تأثير بصري
                    dice1El.style.transform = 'scale(1.2)';
                    dice2El.style.transform = 'scale(1.2)';
                    
                    setTimeout(() => {
                        dice1El.style.transform = 'scale(1)';
                        dice2El.style.transform = 'scale(1)';
                        movePlayer(total);
                    }, 500);
                }
            }, 100);
        }

        // دالة لتحريك اللاعب
        function movePlayer(spaces) {
            const player = players[currentPlayerIndex];
            player.position = (player.position + spaces) % 40;
            movePlayerToken(player.id, player.position);
            
            // التحقق من العقار الذي وقف عليه اللاعب
            handlePropertyLanding(player.position);
        }

        // دالة للتحقق من العقار
        function handlePropertyLanding(position) {
            const property = properties[position];
            if (!property) return;
            
            currentProperty = property;
            
            if (property.type === 'corner' || property.type === 'free') {
                // لا شيء يحدث
            } else if (property.type === 'tax') {
                players[currentPlayerIndex].money -= property.amount;
                updatePlayerInfo();
                alert(`دفعت ضريبة مقدارها ${property.amount} ريال`);
            } else if (property.type === 'goToJail') {
                players[currentPlayerIndex].position = 10; // السجن
                movePlayerToken(players[currentPlayerIndex].id, 10);
                alert('اذهب إلى السجن!');
                endTurn();
            } else if (property.ownedBy === null && (property.price || property.type === 'station' || property.type === 'utility')) {
                // عرض نافذة لشراء العقار
                showBuyPropertyModal(property);
            } else if (property.ownedBy !== null && property.ownedBy !== players[currentPlayerIndex].id) {
                // دفع الإيجار
                payRent(property);
            } else if (property.type === 'chance' || property.type === 'chest') {
                drawCard(property.type);
            }
        }

        // عرض نافذة شراء العقار
        function showBuyPropertyModal(property) {
            propertyDescription.textContent = `وقفت على ${property.name}`;
            propertyPrice.textContent = `سعر الشراء: ${property.price} ريال`;
            buyPropertyModal.style.display = 'block';
        }

        // دفع الإيجار
        function payRent(property) {
            const owner = players.find(p => p.id === property.ownedBy);
            const currentPlayer = players[currentPlayerIndex];
            
            let rent = property.rent;
            if (property.type === 'station') {
                // احتساب الإيجار لمحطات القطار
                const ownedStations = properties.filter(p => p.type === 'station' && p.ownedBy === owner.id).length;
                rent = 25 * Math.pow(2, ownedStations - 1);
            } else if (property.type === 'utility') {
                // احتساب الإيجار للمرافق
                const diceTotal = parseInt(document.getElementById('dice1').textContent) + 
                                  parseInt(document.getElementById('dice2').textContent);
                const ownedUtilities = properties.filter(p => p.type === 'utility' && p.ownedBy === owner.id).length;
                rent = ownedUtilities === 1 ? diceTotal * 4 : diceTotal * 10;
            }
            
            currentPlayer.money -= rent;
            owner.money += rent;
            
            alert(`دفعت إيجار ${rent} ريال لـ ${owner.name} عن ${property.name}`);
            updatePlayerInfo();
            
            if (currentPlayer.money < 0) {
                alert(`يا للأسف! ${currentPlayer.name} أعلن إفلاسه!`);
                // إزالة اللاعب من اللعبة
                players.splice(currentPlayerIndex, 1);
                if (players.length === 1) {
                    endGame(players[0]);
                    return;
                }
                if (currentPlayerIndex >= players.length) currentPlayerIndex = 0;
            }
            
            endTurn();
        }

        // سحب بطاقة فرصة أو خزينة المجتمع
        function drawCard(type) {
            const cards = {
                chance: [
                    "تقدم إلى قصر العلم. إذا مررت بالبدء، استلم 200 ريال",
                    "اذهب مباشرة إلى السجن. لا تمر بالبدء ولا تستلم 200 ريال",
                    "احصل على رخصة بناء. يمكنك بناء منزل إضافي في أي عقار تمتلكه",
                    "لقد فزت بجائزة مهرجان مسقط. استلم 50 ريال",
                    "تم اختيارك سفيراً للسياحة العمانية. استلم 100 ريال من كل لاعب"
                ],
                chest: [
                    "ورثت أرضاً في صلالة. استلم 100 ريال",
                    "دفعت رسوم مدرسة لأطفالك. ادفع 50 ريال",
                    "بيعك لبعض المنتجات التقليدية. استلم 20 ريال",
                    "سددت لك البنك قرضاً. استلم 150 ريال",
                    "دفعت فاتورة كهرباء. ادفع 100 ريال"
                ]
            };
            
            const randomCard = cards[type][Math.floor(Math.random() * cards[type].length)];
            alert(randomCard);
            
            // معالجة بعض التأثيرات (مبسطة)
            if (randomCard.includes("استلم")) {
                const amount = parseInt(randomCard.match(/\d+/)[0]);
                players[currentPlayerIndex].money += amount;
            } else if (randomCard.includes("ادفع")) {
                const amount = parseInt(randomCard.match(/\d+/)[0]);
                players[currentPlayerIndex].money -= amount;
            } else if (randomCard.includes("اذهب مباشرة إلى السجن")) {
                players[currentPlayerIndex].position = 10;
                movePlayerToken(players[currentPlayerIndex].id, 10);
            }
            
            updatePlayerInfo();
            endTurn();
        }

        // دالة لإنهاء الدور
        function endTurn() {
            currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
            updatePlayerInfo();
        }

        // دالة لتحديث معلومات اللاعب الحالي
        function updatePlayerInfo() {
            if (players.length === 0) return;
            
            const player = players[currentPlayerIndex];
            currentPlayerName.textContent = `${player.token} ${player.name}`;
            currentPlayerBalance.textContent = player.money;
            
            // تحديث قائمة العقارات المملوكة
            propertiesList.innerHTML = '';
            const ownedProperties = properties.filter(p => p.ownedBy === player.id);
            ownedProperties.forEach(prop => {
                const li = document.createElement('li');
                li.textContent = `${prop.name}`;
                if (prop.type === 'station' || prop.type === 'utility' || prop.houses > 0) {
                    li.textContent += ` (${prop.rent} ريال إيجار)`;
                }
                propertiesList.appendChild(li);
            });
        }

        // نهاية اللعبة
        function endGame(winner) {
            gameStarted = false;
            alert(`مبروك! ${winner.name} فاز باللعبة!`);
        }

        // إعداد اللاعبين المحدث
        function setupPlayers() {
            const playerCount = parseInt(playerCountSelect.value);
            
            if (!useStudentData) {
                // الطريقة اليدوية التقليدية
                setupManualPlayers(playerCount);
            }
        }

        // إعداد اللاعبين اليدوي
        function setupManualPlayers(playerCount) {
            playerNamesContainer.innerHTML = '';
            playerNamesContainer.style.display = 'block';
            
            for (let i = 0; i < playerCount; i++) {
                const div = document.createElement('div');
                div.className = 'player-setup-section';
                div.innerHTML = `
                    <label for="player-${i}-name">🎮 اسم اللاعب ${i + 1}:</label>
                    <input type="text" id="player-${i}-name" class="oman-btn" style="margin: 10px; padding: 8px; width: 200px;" placeholder="أدخل الاسم" required>
                    <div style="margin: 10px 0;">
                        <label>اختر الرمز: ${playerTokens[i]}</label>
                        <span style="font-size: 24px; margin: 0 10px; color: ${playerColors[i]};">●</span>
                    </div>
                `;
                playerNamesContainer.appendChild(div);
            }
        }

        // عرض شبكة الطلاب للاختيار اليدوي (محدث)
        function showStudentGrid() {
            if (studentData.length === 0) {
                alert('⚠️ لا توجد بيانات طلاب متاحة. يرجى التأكد من الاتصال بالإنترنت أو استخدام الإدخال اليدوي.');
                return;
            }
            
            const selectedClass = document.getElementById('class-selector').value;
            const filteredStudents = filterStudentsByClass(selectedClass);
            
            if (filteredStudents.length === 0) {
                alert('⚠️ لا توجد طلاب في الصف المختار.');
                return;
            }
            
            studentGrid.style.display = 'block';
            studentGrid.innerHTML = '';
            studentGrid.className = 'student-grid';
            
            // إضافة عداد الطلاب
            const counterDiv = document.createElement('div');
            counterDiv.className = 'student-counter';
            const classText = selectedClass ? `الصف ${selectedClass}` : 'جميع الصفوف';
            counterDiv.textContent = `${classText}: ${filteredStudents.length} طالب | المطلوب اختيار: ${playerCountSelect.value}`;
            studentGrid.appendChild(counterDiv);
            
            // إضافة شريط البحث
            const searchDiv = document.createElement('div');
            searchDiv.style.cssText = 'margin-bottom: 15px; text-align: center;';
            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = '🔍 ابحث عن طالب...';
            searchInput.className = 'search-input';
            
            searchInput.addEventListener('input', function() {
                filterAndDisplayStudents(this.value, filteredStudents);
            });
            
            searchDiv.appendChild(searchInput);
            studentGrid.appendChild(searchDiv);
            
            // حاوية بطاقات الطلاب
            const cardsContainer = document.createElement('div');
            cardsContainer.id = 'student-cards-container';
            cardsContainer.className = 'student-grid';
            studentGrid.appendChild(cardsContainer);
            
            // عرض جميع الطلاب
            displayStudentCards(filteredStudents, cardsContainer);
        }

        // تصفية وعرض الطلاب
        function filterAndDisplayStudents(searchTerm, studentsToFilter) {
            const filtered = studentsToFilter.filter(student => 
                student.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (student.number && student.number.toString().includes(searchTerm))
            );
            
            const container = document.getElementById('student-cards-container');
            if (container) {
                displayStudentCards(filtered, container);
            }
        }

        // عرض بطاقات الطلاب (محدث)
        function displayStudentCards(students, container) {
            container.innerHTML = '';
            
            if (students.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">لا توجد نتائج مطابقة للبحث</div>';
                return;
            }
            
            students.forEach((student, index) => {
                const studentCard = document.createElement('div');
                studentCard.className = 'student-card';
                studentCard.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">${student.name}</div>
                    <div style="font-size: 12px; opacity: 0.8;">
                        ${student.number ? `رقم: ${student.number}` : ''}
                        ${student.class ? ` | الصف: ${student.class}` : ''}
                    </div>
                `;
                
                // التحقق من الاختيار المسبق
                if (selectedStudents.find(s => s.name === student.name)) {
                    studentCard.classList.add('selected');
                }
                
                studentCard.onclick = () => toggleStudentSelection(student, studentCard);
                container.appendChild(studentCard);
            });
        }

        // تبديل اختيار الطالب
        function toggleStudentSelection(student, cardElement) {
            playClickSound();
            const playerCount = parseInt(playerCountSelect.value);
            
            if (selectedStudents.find(s => s.name === student.name)) {
                // إزالة الطالب
                selectedStudents = selectedStudents.filter(s => s.name !== student.name);
                cardElement.classList.remove('selected');
            } else {
                // إضافة الطالب
                if (selectedStudents.length < playerCount) {
                    selectedStudents.push(student);
                    cardElement.classList.add('selected');
                } else {
                    alert(`⚠️ لا يمكن اختيار أكثر من ${playerCount} طلاب!`);
                }
            }
            
            updateSelectedStudentsDisplay();
        }

        // تحديث عرض الطلاب المختارين (محدث)
        function updateSelectedStudentsDisplay() {
            selectedStudentsList.innerHTML = '';
            
            if (selectedStudents.length === 0) {
                selectedStudentsList.innerHTML = '<div style="text-align: center; padding: 10px; color: #666;">لم يتم اختيار أي طلاب بعد</div>';
                return;
            }
            
            selectedStudents.forEach((student, index) => {
                const chip = document.createElement('div');
                chip.className = 'selected-student-chip';
                chip.style.cssText += `border: 2px solid ${playerColors[index]};`;
                chip.innerHTML = `
                    <button class="remove-btn" onclick="removeSelectedStudent(${index})" title="إزالة الطالب">&times;</button>
                    <span style="font-size: 20px; margin: 0 8px; color: ${playerColors[index]};">${playerTokens[index]}</span>
                    <span style="font-weight: bold;">${student.name}</span>
                    ${student.number ? `<span style="font-size: 12px; opacity: 0.8; margin-right: 5px;">(${student.number})</span>` : ''}
                    ${student.class ? `<span style="font-size: 12px; opacity: 0.8; margin-right: 5px;">[${student.class}]</span>` : ''}
                `;
                selectedStudentsList.appendChild(chip);
            });
            
            // إضافة عداد
            const counterDiv = document.createElement('div');
            const isComplete = selectedStudents.length === parseInt(playerCountSelect.value);
            counterDiv.className = `selection-status ${isComplete ? 'selection-complete' : 'selection-incomplete'}`;
            counterDiv.textContent = `تم اختيار ${selectedStudents.length} من ${playerCountSelect.value} طلاب`;
            selectedStudentsList.appendChild(counterDiv);
        }

        // إزالة طالب مختار (محدث)
        function removeSelectedStudent(index) {
            playClickSound();
            const removedStudent = selectedStudents[index];
            selectedStudents.splice(index, 1);
            
            // إزالة التحديد من الشبكة
            const studentCards = document.querySelectorAll('.student-card');
            studentCards.forEach(card => {
                const cardName = card.querySelector('div')?.textContent || card.textContent;
                if (cardName === removedStudent.name) {
                    card.classList.remove('selected');
                }
            });
            
            updateSelectedStudentsDisplay();
        }

        // اختيار طلاب عشوائي (محدث)
        function selectRandomStudents() {
            playClickSound();
            const playerCount = parseInt(playerCountSelect.value);
            
            if (studentData.length === 0) {
                alert('⚠️ لا توجد بيانات طلاب متاحة للاختيار العشوائي!');
                return;
            }
            
            const selectedClass = document.getElementById('class-selector').value;
            const availableStudents = filterStudentsByClass(selectedClass);
            
            if (availableStudents.length === 0) {
                alert('⚠️ لا توجد طلاب في الصف المختار!');
                return;
            }
            
            if (availableStudents.length < playerCount) {
                const classText = selectedClass ? `الصف ${selectedClass}` : 'جميع الصفوف';
                alert(`⚠️ عدد الطلاب في ${classText} (${availableStudents.length}) أقل من العدد المطلوب (${playerCount})`);
                return;
            }
            
            // إعادة تعيين الاختيارات
            selectedStudents = [];
            document.querySelectorAll('.student-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // اختيار عشوائي مع ضمان عدم التكرار
            const shuffledStudents = [...availableStudents];
            selectedStudents = [];
            
            for (let i = 0; i < playerCount; i++) {
                const randomIndex = Math.floor(Math.random() * shuffledStudents.length);
                const selectedStudent = shuffledStudents.splice(randomIndex, 1)[0];
                selectedStudents.push(selectedStudent);
            }
            
            // تحديث العرض
            selectedStudents.forEach(student => {
                const studentCards = document.querySelectorAll('.student-card');
                studentCards.forEach(card => {
                    const cardName = card.querySelector('div')?.textContent || card.textContent;
                    if (cardName === student.name) {
                        card.classList.add('selected');
                    }
                });
            });
            
            updateSelectedStudentsDisplay();
            
            // رسالة نجاح مع أسماء المختارين
            const selectedNames = selectedStudents.map(s => s.name).join(', ');
            const classText = selectedClass ? `من الصف ${selectedClass}` : 'من جميع الصفوف';
            alert(`🎲 تم اختيار ${playerCount} طلاب عشوائياً ${classText}!\n\nالطلاب المختارون:\n${selectedNames}`);
        }

        // بدء اللعبة مع اللاعبين المحددين (محدث)
        function startGameWithPlayers() {
            const playerCount = parseInt(playerCountSelect.value);
            players = [];
            
            if (useStudentData) {
                // استخدام بيانات الطلاب
                if (selectedStudents.length !== playerCount) {
                    alert(`⚠️ يرجى اختيار ${playerCount} طلاب بالضبط!`);
                    return;
                }
                
                selectedStudents.forEach((student, i) => {
                    players.push({
                        id: i,
                        name: student.name,
                        color: playerColors[i],
                        token: playerTokens[i],
                        money: 1500,
                        position: 0,
                        properties: []
                    });
                });
            } else {
                // الإدخال اليدوي
                for (let i = 0; i < playerCount; i++) {
                    const nameInput = document.getElementById(`player-${i}-name`);
                    if (!nameInput || !nameInput.value.trim()) {
                        alert(`⚠️ يرجى إدخال اسم اللاعب ${i + 1}!`);
                        return;
                    }
                    
                    players.push({
                        id: i,
                        name: nameInput.value.trim(),
                        color: playerColors[i],
                        token: playerTokens[i],
                        money: 1500,
                        position: 0,
                        properties: []
                    });
                }
            }
            
            initGame();
        }

        // أحداث DOM
        rollBtn.addEventListener('click', () => {
            playClickSound();
            rollDice();
        });
        endTurnBtn.addEventListener('click', () => {
            playClickSound();
            endTurn();
        });
        playerCountSelect.addEventListener('change', setupPlayers);
        startGameBtn.addEventListener('click', () => {
            playClickSound();
            startGameWithPlayers();
        });
        helpBtn.addEventListener('click', () => {
            playClickSound();
            helpModal.style.display = 'block';
        });

        // أزرار التحكم (محدث)
        document.addEventListener('DOMContentLoaded', function() {
            // تحميل بيانات الطلاب مع مؤشر التحميل
            console.log('🔄 جاري تحميل بيانات الطلاب...');
            loadStudentData().then(() => {
                console.log('✅ اكتمل تحميل بيانات الطلاب');
            });

            // إضافة أزرار التحكم
            const homeBtn = document.getElementById('homeBtn');
            const fullscreenBtn = document.getElementById('fullscreenBtn');

            // زر العودة للصفحة الرئيسية
            homeBtn.addEventListener('click', function() {
                playClickSound();
                window.location.href = '../main.html';
            });

            // زر ملء الشاشة
            fullscreenBtn.addEventListener('click', function() {
                playClickSound();
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.log('خطأ في ملء الشاشة:', err);
                    });
                } else {
                    document.exitFullscreen();
                }
            });

            // أزرار اختيار نوع الإدخال (محدث)
            useStudentDataBtn.addEventListener('click', function() {
                playClickSound();
                
                if (studentData.length === 0) {
                    alert('⚠️ لم يتم تحميل بيانات الطلاب بعد. يرجى الانتظار قليلاً أو استخدام الإدخال اليدوي.');
                    return;
                }
                
                useStudentData = true;
                studentSelectionSection.style.display = 'block';
                playerNamesContainer.style.display = 'none';
                
                // إعادة تعيين الاختيارات عند التبديل
                selectedStudents = [];
                updateSelectedStudentsDisplay();
                
                useStudentDataBtn.style.background = 'linear-gradient(135deg, var(--oman-red) 0%, #a01717 100%)';
                manualEntryBtn.style.background = 'linear-gradient(135deg, var(--oman-green) 0%, var(--light-green) 100%)';
                
                // إخفاء شبكة الطلاب مبدئياً
                studentGrid.style.display = 'none';
            });

            manualEntryBtn.addEventListener('click', function() {
                playClickSound();
                useStudentData = false;
                studentSelectionSection.style.display = 'none';
                setupPlayers();
                
                manualEntryBtn.style.background = 'linear-gradient(135deg, var(--oman-red) 0%, #a01717 100%)';
                useStudentDataBtn.style.background = 'linear-gradient(135deg, var(--oman-green) 0%, var(--light-green) 100%)';
            });

            // أزرار اختيار الطلاب
            randomStudentsBtn.addEventListener('click', selectRandomStudents);
            
            manualStudentsBtn.addEventListener('click', function() {
                playClickSound();
                showStudentGrid();
            });

            // مستمع لمحدد الصف
            const classSelector = document.getElementById('class-selector');
            if (classSelector) {
                classSelector.addEventListener('change', function() {
                    playClickSound();
                    // إعادة تعيين الاختيارات عند تغيير الصف
                    selectedStudents = [];
                    updateSelectedStudentsDisplay();
                    
                    // إعادة عرض الشبكة إذا كانت ظاهرة
                    if (studentGrid.style.display === 'block') {
                        showStudentGrid();
                    }
                });
            }

            // إضافة الصوت لجميع الأزرار
            document.querySelectorAll('.oman-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    if (!e.target.hasAttribute('data-no-sound')) {
                        playClickSound();
                    }
                });
            });
        });
        
        // إغلاق النوافذ المنبثقة
        document.querySelectorAll('.close, .close-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                playClickSound();
                this.closest('.modal').style.display = 'none';
            });
        });
        
        // شراء العقار
        buyPropertyBtn.addEventListener('click', function() {
            playClickSound();
            const player = players[currentPlayerIndex];
            const property = currentProperty;
            
            if (player.money >= property.price) {
                player.money -= property.price;
                property.ownedBy = player.id;
                player.properties.push(property.id);
                
                alert(`🎉 تم شراء ${property.name} بـ ${property.price} ريال`);
                updatePlayerInfo();
                buyPropertyModal.style.display = 'none';
                renderBoard(); // لتحديث ألوان العقارات
            } else {
                alert('❌ ليس لديك ما يكفي من المال لشراء هذا العقار!');
            }
        });
        
        // بدء المزاد (مبسطة)
        auctionPropertyBtn.addEventListener('click', function() {
            playClickSound();
            alert('🔨 المزاد سيبدأ (هذه الميزة تحتاج لتطوير إضافي)');
            buyPropertyModal.style.display = 'none';
            endTurn();
        });

        // تهيئة اللعبة عند تحميل الصفحة
        window.addEventListener('DOMContentLoaded', () => {
            setupPlayers();
            setupModal.style.display = 'block';
            
            // تعيين الإدخال اليدوي كافتراضي
            manualEntryBtn.style.background = 'linear-gradient(135deg, var(--oman-red) 0%, #a01717 100%)';
        });
    </script>
</body>
</html>
