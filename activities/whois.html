<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>من هو؟ ❓</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #f0f4f8;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    .header {
      background: #00796B;
      color: white;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 2rem;
    }
    .hint-box {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      font-size: 1.5rem;
      color: #333;
    }
    .options {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
    }
    .option {
      background: #fff;
      padding: 15px 25px;
      border: 2px solid #00796B;
      border-radius: 8px;
      font-size: 1.2rem;
      cursor: pointer;
      transition: 0.3s;
    }
    .option:hover {
      background: #00796B;
      color: white;
    }
    .score-board {
      margin-top: 20px;
      font-size: 1.2rem;
      color: #00796B;
    }
    #feedback {
      margin-top: 15px;
      font-size: 1.5rem;
      font-weight: bold;
    }
    .leaderboard {
      margin-top: 30px;
      font-size: 1.2rem;
      color: #555;
    }
    .timer {
      font-size: 1.2rem;
      margin-top: 10px;
      color: #c62828;
    }
    #teamSelect {
      margin-bottom: 20px;
      font-size: 1rem;
      padding: 10px;
    }
    .student-card {
      display: inline-block;
      padding: 10px 20px;
      margin: 8px;
      border: 2px solid #00796B;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.3s;
    }
    .student-card.selected {
      background-color: #00796B;
      color: white;
    }
    .student-card:hover {
      background-color: #e0f2f1;
    }
    #instructionModal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.6);
      z-index: 1000;
    }
    #instructionModal .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      max-width: 500px;
      margin: 100px auto;
      text-align: center;
    }
  </style>
</head>
<body>
  <audio id="popupSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_655a5b07a3.mp3" preload="auto"></audio>
  <audio id="successSound" src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_1efc695d3d.mp3" preload="auto"></audio>
  <audio id="failSound" src="https://cdn.pixabay.com/download/audio/2021/09/15/audio_f5dffbaad5.mp3" preload="auto"></audio>

  <div class="header">
    <h1>❓ نشاط: من هو؟</h1>
    <p>اختر الصف ونوع النمط لبدء التحدي</p>
    <select id="classSelect"></select>
    <select id="modeSelect">
      <option value="random">فردي عشوائي</option>
      <option value="manual">فردي انتقائي</option>
    </select>
    <button onclick="startGame()">ابدأ</button>
  </div>

  <select id="teamSelect">
    <option value="teamA">🔵 فريق أ</option>
    <option value="teamB">🟢 فريق ب</option>
  </select>

  <div class="hint-box" id="hint">...</div>
  <div class="options" id="options"></div>
  <div id="feedback"></div>
  <div class="timer" id="timer"></div>
  <div class="score-board">
    نقاط فريق أ: <span id="scoreA">0</span> | نقاط فريق ب: <span id="scoreB">0</span>
  </div>
  <div class="leaderboard" id="leaderboard"></div>

  <div id="instructionModal">
    <div class="modal-content">
      <h2>📘 طريقة اللعب</h2>
      <p id="modalText"></p>
      <button onclick="closeInstructionModal()">فهمت ✅</button>
    </div>
  </div>

  <script>
    let allStudents = [], selectedStudents = [], questions = [];
    let currentIndex = 0;
    let scoreA = 0, scoreB = 0;
    let timerInterval, timeLeft = 15;

    async function loadStudentData() {
      const res = await fetch('https://raw.githubusercontent.com/A7mdooh/entertainment-app/main/data/studentData.json');
      return await res.json();
    }

    async function startGame() {
      const classSelect = document.getElementById("classSelect");
      const mode = document.getElementById("modeSelect").value;
      const data = await loadStudentData();
      const selectedClass = classSelect.value;
      if (!selectedClass || !mode) return alert("يرجى اختيار الصف والنمط");

      allStudents = data[selectedClass];
      showInstructions(mode);
    }

    function showInstructions(mode) {
      const modal = document.getElementById("instructionModal");
      const popupSound = document.getElementById("popupSound");
      const text = document.getElementById("modalText");
      popupSound.play();

      if (mode === "manual") {
        text.innerHTML = "👥 سيتم عرض طلاب الصف، اختر المشاركين عبر الضغط على بطاقاتهم، ثم ابدأ النشاط.";
      } else {
        text.innerHTML = "🎲 سيتم اختيار الطلاب تلقائيًا بشكل عشوائي، ويظهر لك تلميح لتخمين من هو الطالب.";
      }

      modal.style.display = "block";
    }

    function closeInstructionModal() {
      document.getElementById("instructionModal").style.display = "none";
      const mode = document.getElementById("modeSelect").value;

      if (mode === "manual") {
        const container = document.createElement("div");
        container.id = "manualSelection";
        container.innerHTML = "<h3>اختر الطلاب للمشاركة:</h3>";
        allStudents.forEach(name => {
          const card = document.createElement("div");
          card.textContent = name;
          card.className = "student-card";
          card.onclick = () => card.classList.toggle("selected");
          container.appendChild(card);
        });
        const btn = document.createElement("button");
        btn.textContent = "بدء النشاط";
        btn.onclick = () => {
          selectedStudents = Array.from(container.querySelectorAll(".selected")).map(el => el.textContent);
          if (!selectedStudents.length) return alert("اختر طالبًا واحدًا على الأقل");
          document.body.removeChild(container);
          generateQuestions();
        };
        container.appendChild(btn);
        document.body.appendChild(container);
      } else {
        selectedStudents = [...allStudents];
        generateQuestions();
      }
    }

    function generateQuestions() {
      const hints = [
        "يساعد زملاءه دائمًا", "يشجع ريال مدريد كأنه فينيسيوس", "يرتدي قميص باريس سان جيرمان",
        "يفتتح يومه بتحليل مباريات الأمس", "إذا سمع كلمة فسحة صار عدّاء", "يسأل أسئلة عجيبة لكن ممتعة",
        "دائمًا مبتسم", "يجلس في الصف الأول", "يرتدي نظارات أنيقة", "كأن تمريراته من دي بروين!"
      ];
      const shuffled = [...selectedStudents].sort(() => 0.5 - Math.random()).slice(0, 10);
      questions = shuffled.map(name => {
        const randoms = allStudents.filter(n => n !== name).sort(() => 0.5 - Math.random()).slice(0, 3);
        const options = [...randoms, name].sort(() => 0.5 - Math.random());
        const hint = hints[Math.floor(Math.random() * hints.length)];
        return { hint, answer: name, options };
      });
      loadQuestion();
    }

    function loadQuestion() {
      const q = questions[currentIndex];
      timeLeft = 15;
      document.getElementById("hint").textContent = q.hint;
      const options = document.getElementById("options");
      options.innerHTML = "";
      q.options.forEach(opt => {
        const div = document.createElement("div");
        div.className = "option";
        div.textContent = opt;
        div.onclick = () => selectAnswer(opt);
        options.appendChild(div);
      });
      startTimer();
    }

    function startTimer() {
      clearInterval(timerInterval);
      document.getElementById("timer").textContent = `⏳ الوقت المتبقي: ${timeLeft} ثانية`;
      timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById("timer").textContent = `⏳ الوقت المتبقي: ${timeLeft} ثانية`;
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          selectAnswer(null);
        }
      }, 1000);
    }

    function selectAnswer(choice) {
      clearInterval(timerInterval);
      const q = questions[currentIndex];
      const feedback = document.getElementById("feedback");
      const team = document.getElementById("teamSelect").value;

      if (choice === q.answer) {
        document.getElementById("successSound").play();
        confetti({ particleCount: 100, spread: 80 });
        feedback.textContent = "إجابة صحيحة! 🎉";
        feedback.style.color = "#388e3c";
        if (team === "teamA") {
          scoreA++; document.getElementById("scoreA").textContent = scoreA;
        } else {
          scoreB++; document.getElementById("scoreB").textContent = scoreB;
        }
      } else {
        document.getElementById("failSound").play();
        feedback.textContent = `❌ خطأ! الإجابة: ${q.answer}`;
        feedback.style.color = "#c62828";
      }

      setTimeout(() => {
        feedback.textContent = "";
        currentIndex++;
        if (currentIndex < questions.length) loadQuestion();
        else showResults();
      }, 2000);
    }

    function showResults() {
      document.getElementById("hint").textContent = "✅ انتهى النشاط!";
      document.getElementById("options").innerHTML = "";
      document.getElementById("timer").textContent = "";
      document.getElementById("leaderboard").innerHTML =
        `النتائج النهائية:<br>🔵 فريق أ: ${scoreA} نقطة<br>🟢 فريق ب: ${scoreB} نقطة`;
    }

    window.onload = async () => {
      const data = await loadStudentData();
      const classSelect = document.getElementById("classSelect");
      for (const cls in data) {
        const opt = document.createElement("option");
        opt.value = cls;
        opt.textContent = `الصف ${cls}`;
        classSelect.appendChild(opt);
      }
    };
  </script>
</body>
</html>
